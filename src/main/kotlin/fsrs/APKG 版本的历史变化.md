# APKG 格式版本历史与兼容性分析

基于对 Anki 源代码 (https://github.com/ankitects/anki) 的深入研究，本文档详细记录了 APKG 格式从项目开始到 25.09 版本的变化历史。

## 主要版本变化时间线

### 1. Anki 23.10 (2023年10月) - 重大格式改革

**版本号变更**:
- 从传统的 `2.1.x` 版本号改为 `年.月` 格式 (23.10, 23.12, 24.xx, 25.xx)

**新格式引入**:
- 引入了全新的 `.anki21b` 集合文件格式
- **旧格式支持**:
  - `Version::Legacy1` → `collection.anki2` (原始 Anki 2.1.x 格式)
  - `Version::Legacy2` → `collection.anki21` (v2 调度器格式) 
  - `Version::Latest` → `collection.anki21b` (最新格式)

**架构版本变化**:
- 旧格式: SchemaVersion::V11
- 新格式: SchemaVersion::V18

**关键变化**:
- Zstd 压缩默认启用
- 媒体列表格式从哈希映射改为新结构
- 默认导出现在使用新格式
- 支持 FSRS 集成调度
- 内置图像遮挡支持

### 2. 数据库架构版本演进

**Schema 11** (旧版)
- Anki 2.1.x 版本的基础架构
- 被 Legacy1 和 Legacy2 APKG 格式使用
- 基本表结构: col, notes, cards, revlog, graves

**Schema 14** (约2020年引入)
- 添加 `deck_config` 表用于牌组配置管理
- 添加 `config` 表用于键值配置存储
- 增强 `tags` 表，改进排序规则

**Schema 15** (2021年引入)
- 主要的笔记类型系统大修
- 添加 `fields`, `templates`, 和 `notetypes` 表
- 改进索引和性能
- 更好支持复杂笔记类型

**Schema 17** (2021年1月引入)
- 标签表重构
- 添加对标签配置的支持 (折叠状态、自定义配置)
- 改进标签管理能力

**Schema 18** (2021年3月引入) - **当前版本**
- Graves 表优化
- 改为 WITHOUT ROWID 格式以获得更好性能
- 为待处理 graves 添加索引 (`idx_graves_pending`)
- 主键改为 (oid, type) 组合

## APKG 格式兼容性时间线

### 1. 原始格式 (2.1之前): `collection.anki2`
- 基本 SQLite 数据库格式
- 有限的调度选项

### 2. Anki 2.1.x 系列 (2018-2023): `collection.anki21`
- 引入 v2 调度器
- 架构版本 11-18 逐步引入
- 渐进式数据库改进

### 3. Anki 23.10+ (2023年10月+): `collection.anki21b`
- **破坏性变更**: 新格式与 Anki < 23.10 不向后兼容
- Zstd 压缩以获得更小文件大小
- 增强的媒体处理
- FSRS 集成
- 内置图像遮挡支持

## 关键破坏性变更

### 1. Anki 23.10
- 放弃对 v1/v2 调度器的支持
- 新 APKG 格式无法被旧版本读取
- 插件需要更新以支持 Qt6 兼容性

### 2. 架构版本变更
- 每个架构升级都需要数据库迁移
- 旧版 Anki 无法打开新版架构数据库

### 3. 媒体处理变更
- 旧格式使用哈希映射作为媒体列表
- 新格式使用不同的媒体管理方法

## JSON 结构和字段格式变更

APKG 格式本质上是一个 ZIP 容器，包含:
- `collection.anki2` / `collection.anki21` / `collection.anki21b` (SQLite 数据库)
- `media` 文件 (JSON 媒体清单)
- 可选的 `meta` 文件 (格式元数据)

**媒体 JSON 变更**:
- 旧格式: `{"media_file": "number"}` (哈希映射格式)
- 新格式: 针对新媒体处理优化的不同结构

## 兼容性矩阵

| Anki 版本 | APKG 格式 | 架构版本 | 说明 |
|----------|----------|----------|------|
| < 2.1.0 | collection.anki2 | V11 | 原始格式 |
| 2.1.0-2.1.66 | collection.anki21 | V11-V18 | 渐进式架构更新 |
| 23.10+ | collection.anki21b | V18 | **破坏性变更** |

## 当前状态 (Anki 25.09)

- **默认导出**: 新格式 (`collection.anki21b`)
- **旧版导出**: 可选，用于与旧版本兼容
- **架构版本**: V18 (自2021年3月起稳定)
- **压缩**: 新格式使用 Zstd，旧格式未压缩

## 对 MuJing 项目的启示

1. **数据库版本**: 当前使用版本 11，与 Anki 2.1.x 兼容
2. **JSON 结构**: Anki 24.11+ 使用更新的 decks JSON 结构
3. **兼容性策略**: 需要支持新旧两种格式以确保广泛兼容性
4. **字段分隔符**: 使用 `\x1f` (单元分隔符) 字符进行字段分隔
5. **时间格式**: 所有时间戳使用 Unix 时间 (秒)
6. **字符编码**: 全程使用 UTF-8 编码

## 参考资料

- Anki 官方文档 (docs.ankiweb.net)
- Anki 数据库结构文档
- FSRS 算法集成文档
- GitHub 提交历史和发布说明

此分析显示，最重要的 APKG 格式变更发生在 Anki 23.10 版本，它引入了具有破坏性变更的全新格式，同时通过旧版导出选项保持向后兼容性。数据库架构从 V11 到 V18 逐步演进，每个版本都添加了新功能和优化。

## 全面兼容性策略建议

### 生成策略
**建议同时生成两个版本**:
1. **新格式 (`collection.anki21b`)**: 针对 Anki 23.10+ 用户
   - 使用 SchemaVersion::V18
   - 启用 Zstd 压缩
   - 包含所有新特性（FSRS、图像遮挡等）

2. **旧格式 (`collection.anki21`)**: 针对 Anki 2.1.x - 23.09 用户  
   - 使用 SchemaVersion::V11
   - 保持未压缩格式
   - 确保向后兼容性

### 读取策略
**需要支持双版本读取**:
1. **优先检测新格式**: 尝试读取 `collection.anki21b`
2. **回退到旧格式**: 如果新格式不存在或无法读取，尝试 `collection.anki21`
3. **格式自动识别**: 根据文件扩展名和内部结构自动判断版本
4. **数据迁移处理**: 读取时可能需要将旧格式数据迁移到新格式结构

### 实现考虑
- **文件命名约定**: 明确区分 `.apkg` (旧格式) 和 `.apkg21b` (新格式)
- **元数据标记**: 在 APKG 包中添加版本标识元数据
- **错误处理**: 提供清晰的版本不兼容错误信息
- **性能优化**: 避免不必要的格式转换开销

这种双版本策略可以确保与所有 Anki 版本（从 2.1.x 到 25.09+）的完全兼容性。