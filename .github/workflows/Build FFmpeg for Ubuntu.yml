name: Build FFmpeg for Ubuntu

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            build-essential \
            libass-dev \
            libtool \
            pkg-config \
            texinfo \
            wget \
            yasm \
            zlib1g-dev \
            nasm \
            cmake

      - name: Download FFmpeg source code
        run: |
          git clone https://git.ffmpeg.org/ffmpeg.git ffmpeg

      - name: Clone & Build whisper.cpp
        run: |
          set -euo pipefail
          PREFIX="/usr/local"
          git clone https://github.com/ggerganov/whisper.cpp.git
          cd whisper.cpp
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX="${PREFIX}" \
                -DWHISPER_BUILD_TESTS=OFF \
                -DWHISPER_BUILD_EXAMPLES=OFF \
                -DWHISPER_BUILD_SHARED_LIB=OFF \
                -DGGML_SHARED=OFF \
                -DWHISPER_NO_ACCELERATE=OFF \
                -DBUILD_SHARED_LIBS=OFF \
                ..
          cmake --build . --config Release -j $(nproc)
          sudo cmake --install .
          
          # 验证安装
          echo "Installed static libraries:"
          find "${PREFIX}/lib" -name "*.a" | sort || true
          
          # 创建正确的 whisper.pc 文件（解决版本问题的关键修复）
          PC_FILE="${PREFIX}/lib/pkgconfig/whisper.pc"
          sudo mkdir -p "${PREFIX}/lib/pkgconfig"
          sudo bash -c "cat > \"$PC_FILE\" << EOF
          prefix=${PREFIX}
          exec_prefix=\\\${prefix}
          libdir=\\\${exec_prefix}/lib
          includedir=\\\${prefix}/include

          Name: whisper
          Description: Port of OpenAI's Whisper model in C/C++
          Version: 1.8.0
          Libs: -L\\\${libdir} -lwhisper -lggml -lggml-cpu -lggml-blas -lggml-base
          Libs.private: -lm -pthread -lstdc++
          Cflags: -I\\\${includedir}
          EOF"

      - name: Configure FFmpeg
        run: |
          cd ffmpeg
          export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          pkg-config --exists whisper || { echo 'whisper package not found'; exit 1; }
          ./configure --disable-everything \
            --disable-ffprobe \
            --enable-ffmpeg \
            --enable-avformat \
            --enable-avcodec \
            --enable-avutil \
            --enable-avfilter \
            --enable-swresample \
            --enable-protocol=file \
            --enable-static \
            --disable-shared \
            --enable-whisper \
            --enable-filter=whisper \
            --enable-decoder=srt \
            --enable-decoder=movtext \
            --enable-decoder=webvtt \
            --enable-decoder=ass \
            --enable-decoder=ssa \
            --enable-decoder=subrip \
            --enable-encoder=srt \
            --enable-encoder=subrip \
            --enable-encoder=movtext \
            --enable-demuxer=mov \
            --enable-demuxer=matroska \
            --enable-demuxer=ass \
            --enable-demuxer=srt \
            --enable-demuxer=webvtt \
            --enable-demuxer=wav \
            --enable-demuxer=mp3 \
            --enable-demuxer=aac \
            --enable-decoder=pcm_s16le \
            --enable-decoder=mp3 \
            --enable-decoder=aac \
            --enable-muxer=srt \
            --enable-protocol=file \
            --pkg-config-flags="--static" \
            --extra-cflags="-I/usr/local/include" \
            --extra-ldflags="-L/usr/local/lib"

      - name: Build and install FFmpeg
        run: |
          cd ffmpeg
          make -j $(nproc)
          sudo make install

      - name: Verify static linking and whisper integration
        run: |
          ldd /usr/local/bin/ffmpeg || true
          file /usr/local/bin/ffmpeg || true
          /usr/local/bin/ffmpeg -hide_banner -filters | grep -i whisper || echo "Whisper filter not found"

      - name: Basic Functional Tests (codecs + whisper presence)
        run: |
          set -euo pipefail
          /usr/local/bin/ffmpeg -version
          /usr/local/bin/ffmpeg -encoders | grep -E "(srt|subrip|movtext)" || echo "Subtitle encoders missing"
          /usr/local/bin/ffmpeg -decoders | grep -E "(srt|movtext|webvtt|ass|ssa)" || echo "Subtitle decoders missing"
          /usr/local/bin/ffmpeg -decoders | grep -E "(mp3|aac|pcm_s16le)" || echo "Audio decoders missing"
          /usr/local/bin/ffmpeg -formats | grep -E "(mov|matroska|srt|wav|mp3|aac)" || echo "Some formats missing"
          /usr/local/bin/ffmpeg -hide_banner -filters | grep -i whisper || echo "Whisper filter missing"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-ubuntu
          path: /usr/local/bin/ffmpeg